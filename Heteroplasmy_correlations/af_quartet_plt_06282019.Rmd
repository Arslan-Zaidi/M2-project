---
title: "Allele frequency correlations"
author: "Arslan Zaidi"
date: "6/28/2019"
output: pdf_document
---


```{r load_libraries, message=FALSE,results="hide",warning=FALSE}

library(data.table)
library(ggplot2)
library(reshape2)
library(gridExtra)
library(dplyr)
library(here)

```

### Introduction

Here, we explore the correlation in heteroplasmy frequency across different tissues from the same person and between the tissue of a mother and her children.

```{r read_files}

#read heterplasmy counts
hq.counts<-fread(
  here("Data_files/hq_counts_adj_frequency_09272018.txt"),
  header=T)

#create individual heteroplasmy ids
hq.counts$individual_het_id<-paste(hq.counts$individual_id,hq.counts$position,sep="_")

#assign a mother's heteroplasmy id to each individual
hq.counts$mother_het_id<-paste(hq.counts$mother_id,hq.counts$position,sep="_")

#keep only heteroplasmies
hq<-hq.counts[,c('FID','mother_id','mot_cat','mother_het_id','individual_id','individual_het_id','tissue_id','position','level','tissue','major','minor','adj.f','age_collection','age_birth','mot_cat')]

```

We need to do some data wrangling to plot these. Pivot the dataframe so each individual's blood and cheek frequencies are in separate columns. Then, calculate and plot the correlation between the heteroplasmy frequency from blood and cheek tissues across all individuals.

```{r plt_tissue_corr}

#plot tissues against each other
#reshape to get frequencies for blood and cheek for each individual
dhq.2t<-dcast(hq,
              FID + mother_id + mot_cat + mother_het_id + individual_id + level + individual_het_id + age_collection + position ~ tissue,
              value.var="adj.f",
              fun.aggregate = mean,
              na.rm=T)

dhq.2t$diff.f<-abs(dhq.2t$bl-dhq.2t$ch)
dhq.2t$avg.f<-apply(dhq.2t[,c('bl','ch')],1,mean)

#calculate correlation between bl and ch frequencies
#filter only individuals who are heteroplasmic in at least one tissue
dhq.2t.poly<-dhq.2t%>%
  filter((bl>=0.01 & bl<=0.99)|(ch>=0.01 & ch<=0.99))

#get correlation and round off for plotting
cor1<-round(with(dhq.2t.poly,cor(bl,ch,method="pearson")),2)

plt.2t<-ggplot(dhq.2t,aes(bl,ch))+
  geom_point(alpha=0.6)+
  theme_bw()+
  geom_abline(intercept=0,
              slope=1,
              color="red")+
  stat_smooth(method="lm",
              se=F)+
  annotate(geom="text",
           x=0.25,
           y=0.75,
           label=paste("r=",cor1))+
  labs(x="Allele frequency - Blood",
       y="Allele frequency - Cheek",
       title="Allele frequency correlation b/w blood and cheek tissue")
  
plt.2t

```

The heteroplasmy frequencies are highly correlated between the blood and cheek tissues of an indivudl. There is little drift in heteroplasmy frequency between blood and cheek tissues since their divergence during development.

Now, we do the same thing for mothers ad children separately. 

```{r split_tissue_corr}
#calculate the correlation between a mother's tissues and child's tissues separately
#to do this, we must first separate mothers and children 
#get mothers and put them in separate dataframe
dhq.mothers<-dhq.2t[which(dhq.2t$mot_cat!=""),]

#get children and put them in separate dataframe
dhq.children<-dhq.2t[which(dhq.2t$mot_cat==""),]

#merge so that each record is a mother joined with her two children
dhq.mc<-merge(dhq.mothers,
              dhq.children[,c('mother_id',
                              "mother_het_id",
                              "individual_id",
                              "level",
                              "bl",
                              "ch",
                              "diff.f",
                              "avg.f")],
              by.x=c("individual_het_id"),
              by.y=c("mother_het_id"),
              all.y=T,
              suffixes=c(".m",".c"))

#correlation between heteroplasmy frequency b/w child's tissues
dhq.c.poly<-dhq.mc%>%
  distinct(FID,individual_id.c,position,.keep_all = T)%>%
  filter((bl.c>=0.01 & bl.c<=0.99) | (ch.c>=0.01 & ch.c<=0.99))
cor2<-round(with(dhq.c.poly,cor(bl.c,ch.c,method="pearson")),2)

#correlation between heteroplasmy frequency b/w mother's tissues
dhq.m.poly<-dhq.mc%>%
  distinct(FID,individual_id.m,position,.keep_all=T)%>%
  filter((bl.m>=0.01 & bl.m<=0.99) | (ch.m>=0.01 & ch.m<=0.99))
cor3<-round(with(dhq.m.poly,cor(bl.m,ch.m,method="pearson")),2)

mother.plt<-
  ggplot(data=dhq.m.poly,aes(bl.m,ch.m))+
  geom_point(alpha=0.7)+
  theme_bw()+
  stat_smooth(method="lm",se=F)+
  geom_abline(intercept=0,slope=1,color="red")+
  labs(x="Mother - blood",y="Mother - cheek")+
  annotate("text",
           x=0.25,
           y=0.90,
           label=paste("r = ",cor2,sep=""),
           size=7)+
  theme(axis.title=element_text(size=14))

child.plt<-
  ggplot(dhq.c.poly,aes(x=bl.c,y=ch.c))+
  geom_point(alpha=0.7)+
  theme_bw()+
  stat_smooth(method="lm",se=F)+
  geom_abline(intercept=0,slope=1,color="red")+
  labs(x="Child - blood",y="Child - cheek")+
  annotate("text",
           x=0.25,
           y=0.90,
           label=paste("r = ",cor3,sep=""),
           size=7)+
  theme(axis.title=element_text(size=14))

```

Next, merge the dataframe for mothers and children so that each heteroplasmy is a single row and its frequency in all four tissues (2 mother and 2 for each child) is displayed in different columns. Then, plot the correlation in heteroplasmy frequency between mothers and children.

```{r mother_child}
#plot mother against child

#correlation between mother and child blood
dhq.mc.bl.poly<-dhq.mc%>%
  filter((bl.m>=0.01 & bl.m<=0.99)|(bl.c>=0.01 & bl.m<=0.99))
cor4<-round(with(dhq.mc.bl.poly,cor(bl.m,bl.c,method="pearson")),2)

blood.plt<-
  ggplot(data=dhq.mc.bl.poly,aes(bl.m,bl.c))+
  geom_point(alpha=0.7)+
  theme_bw()+
  stat_smooth(method="lm",se=F)+
  geom_abline(intercept=0,slope=1,color="red")+
  labs(x="Mother - blood",y="Child - blood")+
  annotate("text",
           x=0.25,
           y=0.90,
           label=paste("r = ",cor4,sep=""),
           size=7)+
  theme(axis.title=element_text(size=14))

#correlation between mother and child cheek
dhq.mc.ch.poly<-dhq.mc%>%
  filter((ch.m>=0.01 & ch.m<=0.99)|(ch.c>=0.01 & ch.m<=0.99))

cor5<-round(with(dhq.mc.ch.poly,cor(ch.m,ch.c,method="pearson")),2)

cheek.plt<-
  ggplot(data=dhq.mc.ch.poly,aes(ch.m,ch.c))+
  geom_point(alpha=0.7)+
  theme_bw()+
  stat_smooth(method="lm",se=F)+
  geom_abline(intercept=0,slope=1,color="red")+
  labs(x="Mother - cheek",y="Child - cheek")+
  annotate("text",
           x=0.25,
           y=0.90,
           label=paste("r = ",cor5,sep=""),
           size=7)+
  theme(axis.title=element_text(size=14))
```

Combine all plots into one.

```{r quartet_plot}

#combine plot
quartet.plt<-grid.arrange(mother.plt,
                          child.plt,
                          blood.plt,
                          cheek.plt)

quartet.plt
# ggsave("files/Analysis/PNAS_styled_analyses/af_correlation_plots/quartet_plots_09142018.pdf",quartet.plt,height=10,width=10)
```

As shown, there is a greater correlation between the two tissues of the same person than between a mother and a child because of the germline bottleneck.
