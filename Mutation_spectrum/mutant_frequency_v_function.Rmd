---
title: "Mutant_frequency_by_function"
author: "Arslan Zaidi"
date: "4/12/2019"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    code_folding: show
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r load_libs}
#code to explore pathogenicity of heteroplasmies
#Q. at what frequency do pathogenic variants exist in tissues

library(ggplot2)
library(dplyr)
library(data.table)
library(Biostrings)
library(here)

```

## Difference in heteroplasmy fraction between deleterious and neutral alleles

### Load ancestral/mutant heteroplasmy data

```{r load_context}
#load heteroplasmies with sequence context info
hq.context<-fread(
  here("Data_files/hq_adjf_ancestral_syn_11282018.txt"),
  header=T,
  sep="\t")

#make column for mutant frequency
#if the mutant frequency is the major allele, the mutant frequency is 1-MAF
hq.context2<-hq.context%>%
  filter(is.na(ancestral)=='FALSE'&ancestral.py!="")%>%
  mutate(mutant.f=case_when(major==ancestral~maf,
                            minor==ancestral~1-maf),
         mutation.id=paste(ancestral.py,position,mutant.py,sep=""))

```


### Load pathogenicity annotation

```{r }
#apogee+mitomap
pat.annot<-fread(
  here("Data_files/pathogenic_annotation_03222019.txt"),
  header=T,
  sep="\t")

#add mutation_id column for merging with hq data
pat.annot<-pat.annot%>%
  mutate(mutation_id=paste(ancestral_py,position,mutant_py,sep=""))

#merge heteroplasmy data with pathogenicity annotation
hq.pat<-merge(hq.context2,pat.annot,by.x="mutation.id",by.y="mutation_id",all.x=T)

#add column for pathogenicity
hq.pat<-hq.pat%>%
  mutate(pathogenicity=case_when(is.na(source)=="FALSE" ~"P",
                                 is.na(source)=="TRUE" ~ "N"))
```

### Frequency differences b/w pathogenic and non-pathogenic heteroplasmies

```{r freq_dfiff}
#calculate the maximum frequency for pathogenic vs non-pathpgenic variants
hqpat_freq<-hq.pat%>%
  group_by(tissue,pathogenicity)%>%
  summarize(mean.f=mean(mutant.f),
            max.f=max(mutant.f),
            nobs=length(mutant.f))

hqpat_freq

```

It's clear that the upper limit of the frequency at which pathogenic mutations exist in human tissues is much lower than that at which non-pathogenic mutations exist. Let's formally test this. We will use a parametric bootstrap approach to do this.

```{r bootstrap_limit}


#write function to subsample and calculate max. frequency
fmax.f<-function(x,n){
  subsample<-replicate(10000,
                       x%>%
    pull(mutant.f)%>%
      sample(size=n,
             replace=T))
  
  return(data.table(sno=seq(1,10000,1),max.f=apply(subsample,2,max)))
}

#bootstrap
fmax.boot<-hq.pat%>%
  group_by(pathogenicity,tissue)%>%
  do(fmax.f(.,23))

#statistically test whether pathogenic mutations have lower max.f than non-pathogenic mutations (non-parametric)
#calculation the proportion of pathogenic pseusosamples that have a greater maximum than the non-pathogenic pseudosamples
dfmax<-dcast(fmax.boot,
             sno~pathogenicity+tissue,
             value.var="max.f")


# calculate for blood
pat.bl.pvalue<-with(dfmax,
                    length(which(P_bl>N_bl))/10000)

print(paste("Pvalue, pathogenic mutations in blood:",pat.bl.pvalue))

#calculate for cheek
pat.ch.pvalue<-with(dfmax,
                    length(which(P_ch>N_ch))/10000)

pval.dat=data.frame(tissue=c("bl","ch"),
                    pvalue=c(pat.bl.pvalue,
                             pat.ch.pvalue))

pval.dat

pval.dat=pval.dat%>%
  mutate(plab=paste("Pvalue[fmax]:",
                    pvalue,
                    sep=""))


```

Plot the frequency distribution of pathogenic and non-pathogenic heteroplasmies

```{r pltpat}

#plot the distribution of mutant frequency for pat/non-pat variants
hq.pat$pathogenicity=factor(hq.pat$pathogenicity,levels=c("P","N"))
plt_hqpat<-ggplot()+
  geom_boxplot(data=hq.pat,aes(tissue,
                             mutant.f,
                             color=pathogenicity),
               size=1)+
  geom_point(data=hq.pat,aes(x=tissue,
                                 y=mutant.f,
                             color=pathogenicity),
             position=position_jitterdodge(jitter.width = 0.2),
             size=0.5)+
  theme_bw()+
  theme(axis.text=element_text(size=14),
        axis.title=element_text(size=16),
        legend.text = element_text(size=14),
        panel.grid.major.x = element_blank())+
  labs(x="Tissue type",
       y="Mutant allele frequency",
       color="Path.")+
  scale_fill_discrete(labels=c("N","P"))+
  scale_x_discrete(labels=c("Blood","Cheek"))+
  scale_y_log10(limits=c(0.005,1.5),
                breaks=c(0.01,seq(0,1,0.5)))

ggsave(here("../files/Analysis/mutation_spectrum/plt_hqpat_f_08212019.pdf"),plt_hqpat,height=4,width=4,useDingbats=F)



# fwrite(hq.pat,"files/Analysis/syn_nsyn_annotation//hq_adjf_ancestral_syn_pathogenic_03222019.txt",col.names = T,row.names = F,quote=F,sep="\t")
plt_hqpat
```

It's clear that pathogenic heteroplasmies are present at much lower frequencies in tissues than non-pathogenic heteroplasmies. This suggests that there is likely selection keeping pathogenic heteroplasmies from reaching appreciable frequencies.

#### Synonymous vs non-synonymous heteroplasmies

Test for a difference in frequency b/w synonymous and non-synonymous heteroplasmies. First, test for both blood and cheek tissues together.

```{r syn_freqall}
#frequency b/w synonymous and non-synonymous mutations
hq.syn<-hq.context2%>%
  filter(syn!="")
  
hqsyn_freq<-hq.syn%>%
  group_by(tissue,syn)%>%
  summarize(mean.f=mean(mutant.f),
            max.f=max(mutant.f),
            nobs=length(mutant.f))

hqsyn_freq

```

Non-synonymous mutations don't appear to be systematically under some frequency threshold relative to synonymous mutations. Let's test this formally. 


```{r}

#bootstrap
fmaxsyn.boot<-hq.syn%>%
  group_by(syn,tissue)%>%
  do(fmax.f(.,68))

#statistically test whether pathogenic mutations have lower max.f than non-pathogenic mutations (non-parametric)
#calculation the proportion of pathogenic pseusosamples that have a greater maximum than the non-pathogenic pseudosamples
dfmax_syn<-dcast(fmaxsyn.boot,
             sno~syn+tissue,
             value.var="max.f")


# calculate for blood
syn.bl.pvalue<-with(dfmax_syn,
                    length(which(nsyn_bl>syn_bl))/10000)

print(paste("Pvalue, non-synonymous mutations in blood:",syn.bl.pvalue))

#calculate for cheek
syn.ch.pvalue<-with(dfmax_syn,
                    length(which(nsyn_ch>syn_ch))/10000)

pvalsyn.dat=data.frame(tissue=c("bl","ch"),
                    pvalue=c(syn.bl.pvalue,
                             syn.ch.pvalue))

pvalsyn.dat

pvalsyn.dat=pvalsyn.dat%>%
  mutate(plab=paste("Pvalue[fmax]:",
                    pvalue,
                    sep=""))




```


Plot frequency distribution for synonymous and non-synonymous heteroplasmies

```{r plt_syn}


#plot the distribution of mutant frequency for pat/non-pat variants
plt_hqsyn<-ggplot()+
  geom_boxplot(data=hq.syn,aes(tissue,
                             mutant.f,
                             color=syn),
               size=1)+
  geom_point(data=hq.syn,aes(x=tissue,
                                 y=mutant.f,
                             color=syn),
             position=position_jitterdodge(jitter.width = 0.2),
             size=0.5)+
  theme_bw()+
  theme(axis.text=element_text(size=14),
        axis.title=element_text(size=16),
        legend.text = element_text(size=14))+
  labs(x="Tissue type",
       y="Mutant allele frequency",
       color="Syn.")+
  scale_fill_discrete(labels=c("NSyn","Syn"))+
  scale_x_discrete(labels=c("Blood","Cheek"))+
  scale_y_log10(limits=c(0.005,1.5),
                breaks=c(0.01,seq(0.1,1,0.5)))

ggsave(here("../files/Analysis/mutation_spectrum/plt_hqsyn_f_08212019.pdf"),
        plt_hqsyn,
        height=4,
        width=4,
       useDingbats=F)


plt_hqsyn

```

The difference in max. frequency between synonymous and non-synonymous mutations is not statistically significant. This is possibly because not all non-synonymous variants might be deleterious or that the pathogenicity might vary a lot for non-synonymous heteroplasmies.

#Table of synonymous/non-synonymous and pathogenic/non-pathogenic mutations