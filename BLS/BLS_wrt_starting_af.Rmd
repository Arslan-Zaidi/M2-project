---
title: "Branch length vs allele frequency"
author: "Arslan Zaidi"
date: "7/4/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Here, we test whether the initial heteroplasmy frequency in the root of the tree impacts the branch lenghts estimated using BLS. To do this, I will simulate heteroplasmies under drift in two populations that have diverged froma single ancestral population using a neutral Wright-Fisher model and estimate from the resulting frequencies, the divergence, or branch lengths, between the two populations.

```{r}
#load libraries
library(ggplot2)
library(data.table)
library(dplyr)
library(here)

#load functions needed to calculate Fst
source(file=here("BLS/scripts/abs_functions_03152019.R"))
```

Write function simulate drift in a heteroplasmy forward in time. 

```{r}
#write function to simulate drift forward in time.
#outputs allele frequency for nloci number of loci
#arguments: 
# p = starting allele frequency, 
# g = no. of generations, 
# nloci = number of independent loc/replicates
# nind = number of haploids
sim.drift<-function(p,g,nloci=100,nind=1000){
  nchrom<-round(nind)
  updated.p1<-rep(p,nloci)
  for(i in 1:g){
    #updated.p1
    updated.p1<-sapply(updated.p1,function(x){rbinom(1,nchrom,x)/nchrom})
  }
  return(updated.p1)
}


```

Carry out the simulation and estimate divergence between the two populations. 

```{r }

#original ancestral population
#initialize with 50 different starting frequencies
p0=seq(0.01,0.5,0.01)
p10=lapply(p0,function(x){
  dxymat=matrix(NA,nrow=100,ncol=1)
  for(i in 1:100){
    #poplation1
    p10.1<-sim.drift(p=0.5,g=10,nloci=100,nind=1000)
    #population2
    p10.2<-sim.drift(p=0.5,g=10,nloci=100,nind=1000)
    #calculate fst between them
    comps=t(mapply(fst_comps, p1=p10.1,p2=p10.2,n1=1000,n2=1000))
    fst=sum(comps[,1])/sum(comps[,2])
    #divergence
    dxymat[i,1]=-log(1-fst)
  }
  dxydat=data.frame(dxy=dxymat[,1],p0=x)
  return(dxydat)
})
p10=bind_rows(p10,.id="pno")
colnames(p10)[2]<-"dxy"


```

Calculate median and 95% CI of divergence at each starting allele frequency

```{r}

dxy_summary<-p10%>%
  group_by(p0)%>%
  summarize(dxy_median=median(dxy),
          dxy_lower=quantile(dxy,probs=0.025),
          dxy_upper=quantile(dxy,probs=0.975))

```

Plot drift experienced by each loci wrt starting allele frequency

```{r}

plt<-ggplot(dxy_summary)+
  geom_point(aes(p0,
                 dxy_median),
             color="red")+
  geom_errorbar(aes(x=p0,
                    ymin=dxy_lower,
                    ymax=dxy_upper))+
  theme_bw()+
  theme(axis.text.x=element_text(angle=90))+
  geom_hline(yintercept=0.01,
             color="red",
             linetype="dashed")+
  labs(x="Starting allele frequency",
       y="Divergence between two populations")+
  scale_x_continuous(breaks=c(0.01,0.1,0.2,0.3,0.4,0.5))


plt


```


### Conclusion: The divergence between two populations estimated from their allele frequencies is not impacted by the initial frequency. 

Save to output file

```{r}

ggsave(here("BLS/BLS_wrt_starting_af.pdf"),
       plt,
       height=4,
       width=6)

```


